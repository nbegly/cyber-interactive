<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 3: Firewall Rules</title>
    <!-- Link to the shared stylesheet -->
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* Sim-specific styles */
        .sim-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .info-btn {
            padding: 8px;
            background-color: var(--interactive-blue);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            line-height: 0;
        }
        .info-btn:hover {
            background-color: var(--interactive-blue-hover);
        }
        .info-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .sim3-diagram { 
            position: relative; 
            height: 600px; 
            background-color: var(--bg-dark-secondary); 
            border-radius: 8px; 
            max-width: 1200px;
            margin: 20px auto;
        }
        #line-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        .sim3-zone { 
            border: 2px solid var(--accent-green); 
            border-radius: 15px; 
            background-color: rgba(76, 175, 80, 0.1); 
            position: absolute; 
            padding: 40px 10px 10px 10px; 
        }
        .sim3-zone-title { 
            position: absolute; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: #aaa; 
        }
        .sim3-device-grid { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            height: 100%; 
        }
        .sim3-device { text-align: center; z-index: 1; }
        .sim3-icon { color: var(--accent-green); }
        .sim3-icon svg { width: 48px; height: 48px; fill: currentColor; }
        .sim3-label { font-size: 0.9em; }
        #public-network { top: 20px; left: 20%; right: 20%; height: 150px; }
        #workstation-network { bottom: 20px; left: 20%; right: 20%; height: 150px; }
        #secure-network { top: 20px; right: 20px; bottom: 20px; width: 15%; }
        #secure-network .sim3-device-grid { flex-direction: column; }
        #internet-icon-sim3 { position: absolute; top: 50%; left: 40px; transform: translateY(-50%); color: var(--accent-green); }
        #firewall-icon-sim3 { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger-red); cursor: pointer; z-index: 2; }
        
        /* Firewall Modal Styles */
        .firewall-header-row, .firewall-rule-row { 
            display: grid; 
            grid-template-columns: 30px 1.5fr 1.5fr 120px 100px 100px; 
            gap: 10px; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        .firewall-header-row { 
            font-weight: bold; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 5px; 
        }
        .firewall-rule-row label { font-weight: bold; }
        .firewall-rule-row select, .firewall-rule-row input { 
            width: 100%; 
            padding: 5px; 
            background-color: var(--bg-dark-tertiary); 
            color: var(--text-light); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
        }
        .modal-footer { text-align: right; margin-top: 20px; }
        .modal-save-btn, .modal-cancel-btn { 
            display: inline-block; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        }
        .modal-cancel-btn { background-color: var(--danger-red); color: white; margin-right: 10px; }
        .modal-save-btn { background-color: var(--accent-green); color: white; }
    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
            <a href="../index.html" class="back-btn">Back to Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <h3>Sim 3: Firewall Configuration</h3>
        <div class="sim3-diagram">
            <canvas id="line-canvas"></canvas>
            <div id="internet-icon-sim3" class="sim3-icon"><svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg></div>
            <div id="firewall-icon-sim3" class="sim3-icon">
                <svg viewBox="0 0 24 24"><path d="M21 6H3V4h18v2zm0 4H3v2h18v-2zm0 4H3v2h18v-2z"/></svg>
                <div>Firewall</div>
            </div>
            <div id="public-network" class="sim3-zone">
                <div class="sim3-zone-title">Public Network Server</div>
                <div class="sim3-device-grid"></div>
            </div>
            <div id="workstation-network" class="sim3-zone">
                <div class="sim3-zone-title">Workstation Network</div>
                <div class="sim3-device-grid"></div>
            </div>
            <div id="secure-network" class="sim3-zone">
                <div class="sim3-zone-title">Secure Network</div>
                <div class="sim3-device-grid"></div>
            </div>
        </div>
        <div class="sim-controls">
            <div></div>
            <div>
                <button class="sim-check-btn" id="checkBtn">Check Answer</button>
                <button class="sim-reset-btn" id="resetBtn">Reset Sim</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div id="modal-body-content"></div>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(content, isCentered = false, options = {}) {
            modalBody.innerHTML = '';
            if (options.isWide) modal.classList.add('modal-wide');
            if (typeof content === 'string') {
                const p = document.createElement('p');
                p.style.whiteSpace = 'pre-wrap';
                p.textContent = content;
                modalBody.appendChild(p);
            } else {
                modalBody.appendChild(content);
            }
            if (!options.noCloseButton) {
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Close';
                closeButton.className = 'modal-close-btn';
                closeButton.onclick = closeModal;
                modalBody.appendChild(closeButton);
            }
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { 
            modal.style.display = "none"; 
            modal.classList.remove('modal-wide');
        }
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const sim3 = {
            state: { rules: [{}, {}, {}, {}] },
            data: {
                info: `SIMULATION\nThe security administration has installed a new firewall which implements an implicit DENY policy by default.\n\nINSTRUCTIONS\nClick on the firewall and configure it to allow ONLY the following communication:\n     The Accounting workstation can ONLY access the web server on the public network over the default HTTPS\n       port. The accounting workstation should not access other networks.\n     The HR workstation should be restricted to communicate with the Financial server ONLY, over the default SCP\n       port.\n     The Admin workstation should ONLY be able to access the server on the secure network over the default TFTP\n       port.\n\nThe firewall will process the rules in a top-down manner in order as a first match. The port number must be typed in and only one port number can be entered per rule. Type ANY for all ports.\n\nIf at any time you would like to bring back the initial state of the simulation, please click the Reset Sim button.`,
                devices: [
                    { name: "Any", ip: "Any" }, { name: "Mail Server", ip: "192.168.10.2" },
                    { name: "DNS Server", ip: "192.168.10.3" }, { name: "App Server", ip: "192.168.10.4" },
                    { name: "Web Server", ip: "192.168.10.5" }, { name: "Accounting", ip: "10.10.9.12" },
                    { name: "Human Resources", ip: "10.10.9.14" }, { name: "Sales", ip: "10.10.9.16" },
                    { name: "Admin", ip: "10.10.9.18" }, { name: "Financial Server", ip: "192.168.100.10" },
                    { name: "Purchasing Server", ip: "192.168.100.18" }
                ],
                ports: ["ANY", "22", "69", "443"],
                protocols: ["ANY", "TCP", "UDP"],
                actions: ["Permit", "Deny"],
                correctAnswers: [
                    { source: "10.10.9.12", destination: "192.168.10.5", port: "443", protocol: "TCP", action: "Permit" },
                    { source: "10.10.9.14", destination: "192.168.100.10", port: "22", protocol: "TCP", action: "Permit" },
                    { source: "10.10.9.18", destination: "192.168.100.10", port: "69", protocol: "ANY", action: "Permit" },
                    { source: "10.10.9.18", destination: "192.168.100.18", port: "69", protocol: "ANY", action: "Permit" }
                ]
            },
            setup: function() {
                this.state.rules = [{}, {}, {}, {}];
                const createDevice = (name, ip, type = 'server') => `<div class="sim3-device"><div class="sim3-icon">${type === 'server' ? '<svg viewBox="0 0 24 24"><path d="M20 15H4v-2h16v2zm0-4H4V9h16v2zm-2-8H6v2h12V3z"/></svg>' : '<svg viewBox="0 0 24 24"><path d="M20 18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>'}</div><div class="sim3-label">${name}<br>${ip}</div></div>`;
                
                document.querySelector('#public-network .sim3-device-grid').innerHTML = createDevice("Mail Server", "192.168.10.2", 'server') + createDevice("DNS Server", "192.168.10.3", 'server') + createDevice("App Server", "192.168.10.4", 'server') + createDevice("Web Server", "192.168.10.5", 'server');
                document.querySelector('#workstation-network .sim3-device-grid').innerHTML = createDevice("Accounting", "10.10.9.12", 'laptop') + createDevice("Human Resources", "10.10.9.14", 'laptop') + createDevice("Sales", "10.10.9.16", 'laptop') + createDevice("Admin", "10.10.9.18", 'laptop');
                document.querySelector('#secure-network .sim3-device-grid').innerHTML = createDevice("Financial Server", "192.168.100.10") + createDevice("Purchasing Server", "192.168.100.18");
                
                document.getElementById('firewall-icon-sim3').onclick = () => this.showFirewallModal();
                this.drawLines();
            },
            drawLines: function() {
                const canvas = document.getElementById('line-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const container = document.querySelector('.sim3-diagram');
                if (!container) return;

                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
                ctx.lineWidth = 2;
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');

                function drawLine(x1, y1, x2, y2) {
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }

                function drawArrow(x, y, angle) {
                    const size = 8;
                    ctx.save();
                    ctx.beginPath();
                    ctx.translate(x, y);
                    ctx.rotate(angle);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(-size, -size / 2);
                    ctx.lineTo(-size, size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }

                function drawLineWithArrow(x1, y1, x2, y2) {
                    drawLine(x1, y1, x2, y2);
                    const angle = Math.atan2(y2 - y1, x2 - x1);
                    drawArrow(x2, y2, angle);
                }
                
                const arrows = [
                    [100, 290, 550, 290],
                    [1070, 290, 1070, 250],
                    [1070, 290, 1070, 375],
                    [340, 215, 340, 195],
                    [515, 215, 515, 195],
                    [690, 215, 690, 195],
                    [860, 215, 860, 195],
                    [330, 425, 330, 445],
                    [525, 425, 525, 445],
                    [710, 425, 710, 445],
                    [870, 425, 870, 445]
                ];
                
                const lines = [
                    [640, 290, 1070, 290],
                    [600, 255, 600, 215],
                    [340, 215, 860, 215],
                    [600, 350, 600, 390],
                    [600, 410, 600, 425],
                    [330, 425, 870, 425]

                ];

                // **FIXED:** Loop through each array and call the correct function
                arrows.forEach(coords => {
                    drawLineWithArrow(coords[0], coords[1], coords[2], coords[3]);
                });
                lines.forEach(coords => {
                    drawLine(coords[0], coords[1], coords[2], coords[3]);
                });
            },
            showFirewallModal: function() {
                const content = document.createElement('div');
                content.innerHTML = `<h4>Firewall Rules</h4><div class="firewall-header-row"><div>#</div><div>Source</div><div>Destination</div><div>Port</div><div>Protocol</div><div>Action</div></div>`;
                const createIpSelect = (options, selectedValue) => '<option value="">Select...</option>' + options.map(opt => `<option value="${opt.ip}" ${selectedValue === opt.ip ? 'selected' : ''}>${opt.ip}</option>`).join('');
                const createGenericSelect = (options, selectedValue) => '<option value="">Select...</option>' + options.map(opt => `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
                
                for (let i = 0; i < 4; i++) {
                    const rule = this.state.rules[i] || {};
                    const ruleRow = document.createElement('div');
                    ruleRow.className = 'firewall-rule-row';
                    ruleRow.innerHTML = `
                        <label>${i + 1}</label>
                        <select id="sim3-source-${i}">${createIpSelect(this.data.devices, rule.source)}</select>
                        <select id="sim3-dest-${i}">${createIpSelect(this.data.devices, rule.destination)}</select>
                        <input type="text" id="sim3-port-${i}" value="${rule.port || ''}" placeholder="">
                        <select id="sim3-proto-${i}">${createGenericSelect(this.data.protocols, rule.protocol)}</select>
                        <select id="sim3-action-${i}">${createGenericSelect(this.data.actions, rule.action)}</select>`;
                    content.appendChild(ruleRow);
                }
                
                const footer = document.createElement('div');
                footer.className = 'modal-footer';
                footer.innerHTML = `<button class="modal-cancel-btn">Cancel</button><button class="modal-save-btn">Save & Close</button>`;
                footer.querySelector('.modal-cancel-btn').onclick = closeModal;
                footer.querySelector('.modal-save-btn').onclick = () => this.saveFirewallRules();
                content.appendChild(footer);
                
                showModal(content, false, { noCloseButton: true, isWide: true });
            },
            saveFirewallRules: function() {
                for (let i = 0; i < 4; i++) {
                    this.state.rules[i] = {
                        source: document.getElementById(`sim3-source-${i}`).value,
                        destination: document.getElementById(`sim3-dest-${i}`).value,
                        port: document.getElementById(`sim3-port-${i}`).value,
                        protocol: document.getElementById(`sim3-proto-${i}`).value,
                        action: document.getElementById(`sim3-action-${i}`).value
                    };
                }
                closeModal();
            },
            check: function() {
                let correctRules = 0;
                const correctAnswers = this.data.correctAnswers;
                const userRules = this.state.rules.filter(r => r.source && r.destination && r.port && r.protocol && r.action);
                
                const matchedCorrect = new Set();
                userRules.forEach(userRule => {
                    const isMatch = correctAnswers.some((correctRule, index) => {
                        if (matchedCorrect.has(index)) return false;
                        const match = userRule.source === correctRule.source &&
                                      userRule.destination === correctRule.destination &&
                                      userRule.port.toUpperCase() === correctRule.port.toUpperCase() &&
                                      userRule.protocol.toUpperCase() === correctRule.protocol.toUpperCase() &&
                                      userRule.action === correctRule.action;
                        if (match) {
                            matchedCorrect.add(index);
                            return true;
                        }
                        return false;
                    });
                    if(isMatch) correctRules++;
                });

                if (correctRules === correctAnswers.length && userRules.length === correctAnswers.length) {
                    showModal("Correct! The firewall rules have been configured properly.", true);
                } else {
                    showModal(`Incorrect. Please review the firewall rules based on the instructions. You have ${correctRules} out of ${correctAnswers.length} rules correct.`, true);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            sim3.setup();
            document.getElementById('checkBtn').addEventListener('click', () => sim3.check());
            document.getElementById('resetBtn').addEventListener('click', () => sim3.setup());
            document.getElementById('infoBtn').onclick = () => {
                showModal(sim3.data.info, false);
            };
            window.addEventListener('resize', () => sim3.drawLines());
        });
    </script>
</body>
</html>
