<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 6: Firewall Redundancy</title>
    <link rel="stylesheet" href="/cyber-main/assets/style.css">
    <style>
        .sim-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .info-btn {
            padding: 8px;
            background-color: var(--interactive-blue);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            line-height: 0;
        }

        .info-btn:hover {
            background-color: var(--interactive-blue-hover);
        }

        .info-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        #sim6-diagram-container { 
            position: relative; 
            max-width: 800px; 
            margin: 20px auto; 
            user-select: none; 
        }

        #line-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #sim6-diagram { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            align-items: center; 
            justify-items: center; 
            height: 400px; 
            gap: 10px; 
            background-color: var(--bg-dark-secondary); 
            padding: 20px; 
            border-radius: 10px;
        }

        .sim6-icon { 
            text-align: center; 
            color: var(--text-light);
            position: relative;
        }

        .sim6-icon svg { 
            width: 60px; 
            height: 60px; 
            fill: currentColor; 
        }

        .sim6-icon p { 
            font-size: 0.9em; 
            margin-top: 5px; 
            line-height: 1.2; 
        }

        .sim6-clickable { 
            cursor: pointer; 
            transition: color 0.2s; 
        }

        .sim6-clickable:hover { 
            color: var(--accent-green-hover); 
        }

        .fw-modal-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }

        .fw-modal-table th, .fw-modal-table td { 
            border: 1px solid var(--border-color); 
            padding: 8px; 
            text-align: center; 
        }

        .fw-modal-table th { 
            background-color: var(--interactive-blue); 
        }

        .fw-modal-table select { 
            width: 95%; 
            background: var(--bg-dark-tertiary); 
            color: var(--text-light); 
            border: 1px solid var(--border-color); 
            padding: 5px; 
            border-radius: 4px; 
        }

        .save-fw-btn { 
            padding: 10px 20px; 
            background-color: var(--accent-green); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-top: 20px; 
            float: right; 
            transition: background-color 0.2s;
        }

        .save-fw-btn:hover { 
            background-color: var(--accent-green-hover); 
        }
        
    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
        <a href="/cyber-main/simulations/security-plus/index.html" class="back-btn">Back to Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <h3>Sim 6: Firewall Redundancy</h3>
        <div id="sim6-diagram-container">
            <canvas id="line-canvas"></canvas>
            <div id="sim6-diagram">
                <div class="sim6-icon" style="grid-area: 2 / 1 / 3 / 2;"><svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg><p>Internet</p></div>
                <div class="sim6-icon" style="grid-area: 1 / 2 / 2 / 3;"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,10.5A1.5,1.5 0 0,0 10.5,12A1.5,1.5 0 0,0 12,13.5A1.5,1.5 0 0,0 13.5,12A1.5,1.5 0 0,0 12,10.5Z"/></svg><p>Datacenter Router<br>10.0.0.254/24</p></div>
                <div class="sim6-icon" style="grid-area: 3 / 2 / 4 / 3;"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,10.5A1.5,1.5 0 0,0 10.5,12A1.5,1.5 0 0,0 12,13.5A1.5,1.5 0 0,0 13.5,12A1.5,1.5 0 0,0 12,10.5Z"/></svg><p>DR Router<br>192.168.0.254/24</p></div>
                <div class="sim6-icon sim6-clickable" data-fw="1" style="grid-area: 1 / 3 / 2 / 4;" title="Configure Firewall 1"><svg viewBox="0 0 24 24"><path d="M21 9V7h-2V5h2V3h-2V1h-2v2h-2V1h-2v2h-2V1h-2v2H9V1H7v2H5V1H3v2H1v6h2v2H1v2h2v2H1v6h2v-2h2v2h2v-2h2v2h2v-2h2v2h2v-2h2V9h-2v2h2v2h-2v-2h2zm-4 4h-2v-2h2v2zm-4 0h-2v-2h2v2z"/></svg><p>Firewall 1</p></div>
                <div class="sim6-icon sim6-clickable" data-fw="2" style="grid-area: 2 / 3 / 3 / 4;" title="Configure Firewall 2"><svg viewBox="0 0 24 24"><path d="M21 9V7h-2V5h2V3h-2V1h-2v2h-2V1h-2v2h-2V1h-2v2H9V1H7v2H5V1H3v2H1v6h2v2H1v2h2v2H1v6h2v-2h2v2h2v-2h2v2h2v-2h2v2h2v-2h2V9h-2v2h2v2h-2v-2h2zm-4 4h-2v-2h2v2zm-4 0h-2v-2h2v2z"/></svg><p>Firewall 2</p></div>
                <div class="sim6-icon sim6-clickable" data-fw="3" style="grid-area: 3 / 3 / 4 / 4;" title="Configure Firewall 3"><svg viewBox="0 0 24 24"><path d="M21 9V7h-2V5h2V3h-2V1h-2v2h-2V1h-2v2h-2V1h-2v2H9V1H7v2H5V1H3v2H1v6h2v2H1v2h2v2H1v6h2v-2h2v2h2v-2h2v2h2v-2h2v2h2v-2h2V9h-2v2h2v2h-2v-2h2zm-4 4h-2v-2h2v2zm-4 0h-2v-2h2v2z"/></svg><p>Firewall 3</p></div>
                <div class="sim6-icon" style="grid-area: 1 / 4 / 2 / 5;"><svg viewBox="0 0 24 24"><path d="M20,18H4V8H20M20,6H4A2,2 0 0,0 2,8V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8A2,2 0 0,0 20,6M18,10H6V12H18V10M18,14H6V16H18V14Z" /></svg><p>Web Server<br>10.0.0.1/24</p></div>
                <div class="sim6-icon" style="grid-area: 2 / 4 / 3 / 5;"><svg viewBox="0 0 24 24"><path d="M20,18H4V8H20M20,6H4A2,2 0 0,0 2,8V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8A2,2 0 0,0 20,6M18,10H6V12H18V10M18,14H6V16H18V14Z" /></svg><p>Email Server<br>10.0.1.1/24</p></div>
                <div class="sim6-icon" style="grid-area: 3 / 4 / 4 / 5;"><svg viewBox="0 0 24 24"><path d="M20,18H4V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4Z" /></svg><p>Web Server<br>192.168.0.1/24</p></div>
            </div>
        </div>
        <div class="sim-controls">
            <div></div>
            <div>
                <button class="sim-check-btn" id="checkBtn">Check Answer</button>
                <button class="sim-reset-btn" id="resetBtn">Reset Sim</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div id="modal-body-content"></div>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(content, isCentered = false, options = {}) {
            modalBody.innerHTML = '';
            if (options.isWide) modal.classList.add('modal-wide');
            if (typeof content === 'string') {
                const p = document.createElement('p');
                p.style.whiteSpace = 'pre-wrap';
                p.textContent = content;
                modalBody.appendChild(p);
            } else {
                modalBody.appendChild(content);
            }
            if (!options.noCloseButton) {
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Close';
                closeButton.className = 'modal-close-btn';
                closeButton.onclick = closeModal;
                modalBody.appendChild(closeButton);
            }
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { 
            modal.style.display = "none"; 
            modal.classList.remove('modal-wide');
        }
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const sim6 = {
            state: { firewallConfigs: {} },
            data: {
                info: `SIMULATION\nA company recently added a DR site and is redesigning the network. Users at the DR site are having issues browsing websites.\n\nINSTRUCTIONS\nClick on each firewall to do the following:\n1. Deny cleartext web traffic.\n2. Ensure secure management protocols are used.\n3. Resolve issues at the DR site.\n\nThe ruleset order cannot be modified due to outside constraints.\n\nIf at any time you would like to bring back the initial state of the simulation, please click the Reset Sim button.`
            },
            getDefaultConfig: function() {
                return JSON.parse(JSON.stringify({
                    'DNS Rule': { source: 'ANY', destination: 'ANY', service: 'ANY', action: 'PERMIT' },
                    'HTTPS Outbound': { source: 'ANY', destination: 'ANY', service: 'ANY', action: 'PERMIT' },
                    'Management': { source: 'ANY', destination: 'ANY', service: 'ANY', action: 'PERMIT' },
                    'HTTPS Inbound': { source: 'ANY', destination: 'ANY', service: 'ANY', action: 'PERMIT' },
                    'HTTP Inbound': { source: 'ANY', destination: 'ANY', service: 'ANY', action: 'PERMIT' }
                }));
            },
            setup: function() {
                this.state.firewallConfigs = {};
                document.querySelectorAll('.sim6-clickable').forEach(btn => {
                    btn.onclick = (e) => this.createFirewallModal(e.currentTarget.dataset.fw);
                });
                this.drawLines();
            },
            drawLines: function() {
                const canvas = document.getElementById('line-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const container = document.getElementById('sim6-diagram-container');
                if (!container) return;

                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
                ctx.lineWidth = 2;
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');

                function drawLine(x1, y1, x2, y2) {
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }

                function drawArrow(x, y, angle) {
                    const size = 8;
                    ctx.save();
                    ctx.beginPath();
                    ctx.translate(x, y);
                    ctx.rotate(angle);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(-size, -size / 2);
                    ctx.lineTo(-size, size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }

                function drawLineWithArrow(x1, y1, x2, y2) {
                    drawLine(x1, y1, x2, y2);
                    const angle = Math.atan2(y2 - y1, x2 - x1);
                    drawArrow(x2, y2, angle);
                }
                
                const arrows = [
                    [110, 50, 260, 50],
                    [110, 330, 260, 330],
                    [305, 200, 305, 140],
                    [305, 200, 305, 285],
                    [400, 200, 450, 200],
                    [400, 50, 350, 50],
                    [400, 50, 450, 50],
                    [400, 330, 450, 330],
                    [400, 330, 350, 330],
                    [110, 50, 110, 165],
                    [110, 330, 110, 270],
                    [400, 65, 350, 65],
                    [535, 50, 650, 50],
                    [535, 200, 650, 200],
                    [535, 330, 650, 330]

                ];
                
                const lines = [
                    [400, 65, 400, 200],
                    
                ];

                arrows.forEach(coords => {
                    drawLineWithArrow(coords[0], coords[1], coords[2], coords[3]);
                });
                lines.forEach(coords => {
                    drawLine(coords[0], coords[1], coords[2], coords[3]);
                });
            },
            createFirewallModal: function(fwId) {
                const ruleNames = ['DNS Rule', 'HTTPS Outbound', 'Management', 'HTTPS Inbound', 'HTTP Inbound'];
                const sourceDestOptions = ['ANY', '10.0.0.1/24', '10.0.1.1/24', '192.168.0.1/24'];
                const serviceOptions = ['ANY', 'DNS', 'HTTP', 'HTTPS', 'TELNET', 'SSH'];
                const actionOptions = ['PERMIT', 'DENY'];
                
                const currentConfig = this.state.firewallConfigs[fwId] || this.getDefaultConfig();

                let rulesHtml = ruleNames.map(ruleName => {
                    const config = currentConfig[ruleName];
                    return `<tr>
                        <td>${ruleName}</td>
                        <td><select data-field="source">${sourceDestOptions.map(s => `<option ${config.source === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                        <td><select data-field="destination">${sourceDestOptions.map(s => `<option ${config.destination === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                        <td><select data-field="service">${serviceOptions.map(s => `<option ${config.service === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                        <td><select data-field="action">${actionOptions.map(a => `<option ${config.action === a ? 'selected' : ''}>${a}</option>`).join('')}</select></td>
                    </tr>`;
                }).join('');

                const modalBody = document.createElement('div');
                modalBody.innerHTML = `
                    <h4>Firewall ${fwId} Rules</h4>
                    <table class="fw-modal-table">
                        <thead><tr><th>Rule Name</th><th>Source</th><th>Destination</th><th>Service</th><th>Action</th></tr></thead>
                        <tbody>${rulesHtml}</tbody>
                    </table>
                    <button class="save-fw-btn">Save & Close</button>`;
                
                modalBody.querySelector('.save-fw-btn').onclick = () => {
                    if (!this.state.firewallConfigs[fwId]) {
                        this.state.firewallConfigs[fwId] = {};
                    }
                    modalBody.querySelectorAll('tbody tr').forEach(row => {
                        const ruleName = row.cells[0].innerText;
                        this.state.firewallConfigs[fwId][ruleName] = {
                            source: row.querySelector('[data-field="source"]').value,
                            destination: row.querySelector('[data-field="destination"]').value,
                            service: row.querySelector('[data-field="service"]').value,
                            action: row.querySelector('[data-field="action"]').value
                        };
                    });
                    closeModal();
                };
                showModal(modalBody, false, { noCloseButton: true, isWide: true });
            },
            check: function() {
                const correctAnswers = {
                    '1': { 'HTTP Inbound': { action: 'DENY' }, 'Management': { service: 'SSH' } },
                    '2': { 'HTTP Inbound': { action: 'DENY' }, 'Management': { service: 'SSH' } },
                    '3': { 'HTTP Inbound': { action: 'DENY' }, 'Management': { service: 'SSH' } }
                };
                let allCorrect = true;
                
                for (let fwId = 1; fwId <= 3; fwId++) {
                    const fwKey = `${fwId}`;
                    const correctFwRules = correctAnswers[fwKey];
                    const userFwRules = this.state.firewallConfigs[fwKey] || this.getDefaultConfig();

                    for (const ruleName in correctFwRules) {
                        const userRule = userFwRules[ruleName];
                        const correctRule = correctFwRules[ruleName];

                        if (!userRule || 
                            (correctRule.action && userRule.action !== correctRule.action) || 
                            (correctRule.service && userRule.service !== correctRule.service)) {
                            allCorrect = false;
                            break; 
                        }
                    }
                    if (!allCorrect) break;
                }
                showModal(allCorrect ? "Correct! All configurations are set properly." : "Incorrect. Please review the firewall configurations based on the simulation instructions.", true);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            sim6.setup();
            document.getElementById('checkBtn').addEventListener('click', () => sim6.check());
            document.getElementById('resetBtn').addEventListener('click', () => sim6.setup());
            document.getElementById('infoBtn').onclick = () => {
                showModal(sim6.data.info, false);
            };
            window.addEventListener('resize', () => sim6.drawLines());
        });
    </script>
<script src="/cyber-main/disable_dev_tools.js"></script>
</body>
</html>
