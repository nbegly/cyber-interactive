<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 14: 99.9999% SLA</title>
    <link rel="stylesheet" href="../../../assets/style.css">
    <style>
        .sim-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .info-btn {
            padding: 8px;
            background-color: var(--interactive-blue);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            line-height: 0;
        }

        .info-btn:hover {
            background-color: var(--interactive-blue-hover);
        }

        .info-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        #sim14-wrapper {
            position: relative;
            padding-top: 10px; 
            padding-bottom: 10px; 
        }

        .sim14-icon {
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            color: var(--accent-green);
        }

        .sim14-icon svg {
            width: 48px;
            height: 48px;
            fill: currentColor;
        }

        #internet-icon {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        #utility-icon {
            top: 715px;
            left: 235px;
        }

        .sim14-main-container {
            background-color: var(--bg-dark-secondary);
            border: 2px solid var(--accent-green);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            min-height: 700px;
            max-width: 800px; 
            margin: 0 auto;
        }

        #line-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
        }

        .sim14-item {
            position: absolute;
            text-align: center;
            z-index: 2;
        }

        .sim14-item select, .sim14-bubble select {
            width: 140px;
            padding: 5px;
            background-color: var(--bg-dark-tertiary);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .sim14-label {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px;
            color: #aaa;
            width: 100%;
            text-align: center;
        }

        .sim14-bubble {
            border: 2px solid var(--accent-green);
            border-radius: 15px;
            background-color: rgba(76, 175, 80, 0.1);
            position: absolute;
            z-index: 1;
        }

        .sim14-bubble .server-icon-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--accent-green);
        }

         .sim14-bubble .dropdown-container {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        #dd_top_center_1_container { 
            top: 30px; left: 50%; transform: translateX(-50%); 
        }

        #dd_top_center_2_container { 
            top: 100px; left: 50%; transform: translateX(-50%); 
        }

        #upper-mid-row-container { 
            top: 185px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; gap: 10px; width: 100%; 
        }

        #dd_side_far_left { 
            top: 300px; left: 10%; 
        } 

        #dd_side_far_right { 
            top: 300px; right: 10%; 
        } 

        #server-a-bubble { 
            top: 370px; left: 50%; transform: translateX(calc(-350px - 10px)); width: 350px; height: 220px; 
        }

        #server-b-bubble { 
            top: 370px; left: 50%; transform: translateX(10px); width: 350px; height: 220px; 
        }

        #bottom-row-container { 
            top: 650px; left: 10%; right: 10%; display: flex; justify-content: space-between; align-items: center; 
        }

        .bottom-right-wrapper { 
            display: flex; gap: 10px; 
        }
    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
            <a href="../index.html" class="back-btn">Back to Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <div id="sim14-wrapper">
            <h3>Sim 14: 99.9999% SLA Redundancy</h3>
            <div id="internet-icon" class="sim14-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg></div>
            <div class="sim14-main-container">
                <canvas id="line-canvas"></canvas>
            </div>
            <div id="utility-icon" class="sim14-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h14v-8h3L12 3zm0 14.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg></div>
            <div class="sim-controls">
                <div></div>
                <div>
                    <button class="sim-check-btn" id="checkBtn">Check Answer</button>
                    <button class="sim-reset-btn" id="resetBtn">Reset Sim</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div id="modal-body-content"></div>
            <button class="modal-close-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(content, isCentered = true) {
            modalBody.innerHTML = '';
            if (typeof content === 'string') {
                const p = document.createElement('p');
                p.style.whiteSpace = 'pre-wrap';
                p.textContent = content;
                modalBody.appendChild(p);
            } else {
                modalBody.appendChild(content);
            }
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { modal.style.display = "none"; }
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const sim14 = {
            state: {},
            data: {
                info: `SIMULATION\nA security architect is tasked with designing a highly resilient, business-critical application. The application SLA is 99.999%.\n\nINSTRUCTIONS\nSelect the network, power, and server components for the appropriate locations to achieve application resiliency.\n\nA component should be selected for each location, and components may be selected more than once.\n\nIf at any time you would like to bring back the initial state of the simulation, please click the Reset Sim button.`,
                options: ["", "UPS A", "Load balancers", "Cloud Service Provider", "SONET ring", "Layer 3 device", "Power supply B", "Proxy", "Active-passive firewalls", "Layer 4 firewall", "Active-active firewalls", "Generator", "Active-standby routers", "SAN", "ISP", "Active-active routers", "UPS B", "Power supply A"],
                correctAnswers: {
                    "dd_top_center_1": "Active-active routers", "dd_top_center_2": "Active-active firewalls",
                    "dd_upper_mid_center": "Load balancers", "dd_upper_mid_left": "Active-active firewalls",
                    "dd_upper_mid_right": "Active-active routers", "dd_side_far_left": "Load balancers",
                    "dd_side_far_right": "Load balancers", "dd_server_a_nic": "Power supply A",
                    "dd_server_a_pdu": "Power supply B", "dd_server_b_nic": "Power supply A",
                    "dd_server_b_pdu": "Power supply B", "dd_bottom_left": "UPS A",
                    "dd_bottom_center": "UPS B", "dd_bottom_right": "SONET ring"
                }
            },
            setup: function() {
                this.state = {};
                const container = document.querySelector('.sim14-main-container');
                const createDropdown = (id) => {
                    const options = this.data.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    return `<select id="${id}" onchange="sim14.state['${id}'] = this.value;"><option value="">Select...</option>${options}</select>`;
                };
                
                container.querySelectorAll('.sim14-item, .sim14-bubble').forEach(el => el.remove());

                container.innerHTML += `
                    <div id="server-a-bubble" class="sim14-bubble"><div class="sim14-label">Web server A</div><div class="server-icon-container sim14-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 15H4v-2h16v2zm0-4H4V9h16v2zm-2-8H6v2h12V3z"/></svg><div>NIC</div></div><div class="dropdown-container">${createDropdown('dd_server_a_nic')}${createDropdown('dd_server_a_pdu')}</div></div>
                    <div id="server-b-bubble" class="sim14-bubble"><div class="sim14-label">Web server B</div><div class="server-icon-container sim14-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 15H4v-2h16v2zm0-4H4V9h16v2zm-2-8H6v2h12V3z"/></svg><div>NIC</div></div><div class="dropdown-container">${createDropdown('dd_server_b_nic')}${createDropdown('dd_server_b_pdu')}</div></div>
                    <div id="dd_top_center_1_container" class="sim14-item">${createDropdown('dd_top_center_1')}</div>
                    <div id="dd_top_center_2_container" class="sim14-item">${createDropdown('dd_top_center_2')}</div>
                    <div id="upper-mid-row-container" class="sim14-item">${createDropdown('dd_upper_mid_left')}${createDropdown('dd_upper_mid_center')}${createDropdown('dd_upper_mid_right')}</div>
                    <div id="dd_side_far_left" class="sim14-item">${createDropdown('dd_side_far_left')}</div>
                    <div id="dd_side_far_right" class="sim14-item">${createDropdown('dd_side_far_right')}</div>
                    <div id="bottom-row-container" class="sim14-item"><div class="bottom-left-wrapper">${createDropdown('dd_bottom_left')}</div><div class="bottom-right-wrapper">${createDropdown('dd_bottom_center')}${createDropdown('dd_bottom_right')}</div></div>
                `;
                
                setTimeout(() => this.drawLines(), 100);
            },
            drawLines: function() {
                const canvas = document.getElementById('line-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const container = document.querySelector('.sim14-main-container');
                if (!container) return;

                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
                ctx.lineWidth = 2;
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');

                function drawLine(x1, y1, x2, y2) {
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }

                function drawArrow(x, y, angle) {
                    const size = 8;
                    ctx.save();
                    ctx.beginPath();
                    ctx.translate(x, y);
                    ctx.rotate(angle);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(-size, -size / 2);
                    ctx.lineTo(-size, size / 2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }

                function drawLineWithArrow(x1, y1, x2, y2) {
                    drawLine(x1, y1, x2, y2);
                    const angle = Math.atan2(y2 - y1, x2 - x1);
                    drawArrow(x2, y2, angle);
                }
                
                const arrows = [
                    [400, 75, 400, 90], [400, 85, 400, 70], [420, 10, 420, 0],
                    [140, 15, 140, 290], [700, 15, 700, 290], [420, 145, 420, 175],
                    [420, 170, 420, 140], [160, 200, 160, 290], [160, 200, 190, 200],
                    [680, 200, 680, 290], [680, 200, 650, 200], [275, 45, 275, 175],
                    [275, 45, 340, 45], [565, 45, 565, 175], [565, 45, 500, 45],
                    [380, 450, 380, 225], [460, 450, 460, 225], [0, 660, 70, 660],
                    [200, 660, 450, 660], [700, 720, 700, 690], [700, 670, 700, 600],
                    [290, 615, 290, 600], [500, 650, 500, 600], [200, 630, 200, 600]
                ];
                
                const lines = [
                    [420, 5, 420, 15], [420, 15, 140, 15], [420, 15, 700, 15],
                    [290, 450, 380, 450], [550, 450, 460, 450], [150, 660, 150, 720],
                    [150, 720, 700, 720], [700, 615, 290, 615], [500, 630, 200, 630]
                ];

                // **FIXED:** Loop through each array and call the correct function
                arrows.forEach(coords => {
                    drawLineWithArrow(coords[0], coords[1], coords[2], coords[3]);
                });
                lines.forEach(coords => {
                    drawLine(coords[0], coords[1], coords[2], coords[3]);
                });
            },
            check: function() {
                let correctCount = 0;
                const totalChecks = Object.keys(this.data.correctAnswers).length;
                let allSelected = true;

                for (const id in this.data.correctAnswers) {
                    if (!this.state[id] || this.state[id] === "") {
                        allSelected = false;
                    }
                    if (this.state[id] === this.data.correctAnswers[id]) {
                        correctCount++;
                    }
                }

                if (!allSelected) {
                    showModal("Please make a selection for every component.", true);
                    return;
                }

                if (correctCount === totalChecks) {
                    showModal("Correct! This configuration provides the required resiliency for a 99.999% SLA.", true);
                } else {
                    showModal(`Incorrect. You have correctly configured ${correctCount} out of ${totalChecks} components correct.`, true);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            sim14.setup();
            document.getElementById('checkBtn').addEventListener('click', () => sim14.check());
            document.getElementById('resetBtn').addEventListener('click', () => sim14.setup());
            document.getElementById('infoBtn').onclick = () => {
                showModal(sim14.data.info, false);
            };
            window.addEventListener('resize', () => sim14.drawLines());
        });
    </script>
<script src="/cyber-main/disable_dev_tools.js"></script>
</body>
</html>
