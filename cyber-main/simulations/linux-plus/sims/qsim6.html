<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 6: Remote Access</title>
    <link rel="stylesheet" href="../../../assets/style.css">
    <style>
        .sim-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .info-btn {
            padding: 8px;
            background-color: var(--interactive-blue);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            line-height: 0;
        }

        .info-btn:hover {
            background-color: var(--interactive-blue-hover);
        }

        .info-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        #sim6-main-container {
            background-color: var(--bg-dark-secondary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #sim6-top-panel {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid #333;
            gap: 20px;
        }

        .sim6-icon-container { 
            text-align: center; cursor: pointer; 
        }

        .sim6-icon-circle {
            width: 80px;
            height: 80px;
            background-color: #333;
            border: 2px solid var(--accent-green);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 10px;
            transition: border-color 0.3s;
        }

        .sim6-icon-container:hover .sim6-icon-circle { 
            border-color: var(--interactive-blue-hover); 
        }

        .sim6-icon-svg { 
            width: 50px; height: 50px; stroke: var(--accent-green); 
        }

        .sim6-icon-container .label { 
            font-weight: bold; color: #e0e0e0; 
        }

        .sim6-connecting-line { 
            flex-grow: 1; max-width: 100px; height: 4px; background-color: var(--accent-green); 
        }

        #terminal-output { 
            background: #000; color: #0f0; padding: 15px; border-radius: 5px; height: 350px; overflow-y: auto; margin: 20px 0 10px 0; font-family: monospace; white-space: pre-wrap; 
        }

        .command-line { 
            display: flex; background: #000; border-radius: 5px; padding: 0 10px; border: 1px solid #333; 
        }

        .prompt { 
            color: #88ff88; font-family: monospace; line-height: 40px; white-space: nowrap; 
        }

        #command-input { 
            width: 100%; box-sizing: border-box; padding: 10px; font-family: monospace; border: none; background: transparent; color: #fff; 
        }

        #command-input:focus { 
            outline: none; 
        }

        .sim6-server-modal { 
            display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; 
        }

        .sim6-modal-content { 
            background-color: #2a2a2a; padding: 0; border: 1px solid #444; width: 90%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); color: #e0e0e0; 
        }

        .sim6-modal-header { 
            padding: 10px 15px; background-color: #333; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; border-bottom: 1px solid #444;
        }

        .sim6-modal-header h2 { 
            margin: 0; font-size: 1.2em; 
        }

        .sim6-close-button { 
            color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; 
        }

        .sim6-modal-body { 
            padding: 20px; 
        }

        .sim6-modal-tabs .sim6-modal-tab-btn { 
            background: #333; color: #fff; border: 1px solid #444; border-bottom: none; margin-right: 5px; padding: 10px 15px; border-radius: 5px 5px 0 0; cursor: pointer; 
        }

        .sim6-modal-tabs .sim6-modal-tab-btn.active { 
            background: var(--accent-green); color: var(--bg-dark-primary); font-weight: bold; 
        }

        .sim6-tab-content { 
            display: none; padding: 15px; border: 1px solid #444; border-top: none; border-radius: 0 0 5px 5px; 
        }

        .sim6-tab-content.active { 
            display: block; 
        }

        .sim6-radio-options { 
            background-color: #000; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; 
        }

        .sim6-radio-options label { 
            display: block; margin: 10px 0; cursor: pointer; 
        }

    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
            <a href="../index.html" class="back-btn">Back to Linux+ Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <h3>Sim 6: Remote Access Setup</h3>
        <p>Using the workstation, create and copy an SSH key to Server 1. Then configure Server 1 to disable password logins.</p>

        <div id="sim6-main-container">
             <div id="sim6-top-panel">
                <div class="sim6-icon-container" id="sim6-workstation-icon" title="Reset Simulation">
                    <div class="sim6-icon-circle"><svg class="sim6-icon-svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><rect x="2" y="4" width="20" height="14" rx="2" ry="2"></rect><line x1="2" y1="18" x2="22" y2="18"></line><path d="M6 20h12"></path></svg></div>
                    <div class="label">Workstation</div>
                </div>
                <div class="sim6-connecting-line"></div>
                <div class="sim6-icon-container" id="sim6-server-icon" title="Configure Server 1">
                    <div class="sim6-icon-circle"><svg class="sim6-icon-svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke="currentColor"><rect x="6" y="2" width="12" height="8" rx="1"></rect><rect x="6" y="14" width="12" height="8" rx="1"></rect><line x1="9" y1="6" x2="9.01" y2="6"></line><line x1="9" y1="18" x2="9.01" y2="18"></line></svg></div>
                    <div class="label">Server 1</div>
                </div>
            </div>
            <div id="terminal-wrapper">
                <h4>Workstation</h4>
                <div id="terminal-output"></div>
                <div class="command-line">
                    <span class="prompt">comptia@localhost ~#&nbsp;</span>
                    <input id="command-input" type="text" autocomplete="off" autofocus>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <pre id="modal-body-content" style="white-space: pre-wrap; font-family: sans-serif;"></pre>
            <button class="modal-close-btn">Close</button>
        </div>
    </div>

    <div id="sim6-server-modal" class="sim6-server-modal">
        <div class="sim6-modal-content">
            <div class="sim6-modal-header">
                <h2>Server 1 Configuration</h2>
                <span class="sim6-close-button">&times;</span>
            </div>
            <div class="sim6-modal-body">
                <div class="sim6-modal-tabs">
                    <button class="sim6-modal-tab-btn active" data-tab="disable">Disable</button>
                    <button class="sim6-modal-tab-btn" data-tab="implement">Implement</button>
                </div>
                <div id="disable-tab" class="sim6-tab-content active">
                    <p>Select the command to disable password authentication for SSH login.</p>
                    <div class="sim6-radio-options" id="disable-options">
                        <label><input type="radio" name="disable_cmd" value='sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config'> sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config</label>
                        <label><input type="radio" name="disable_cmd" value='echo password_authentication > /etc/ssh/sshd_config'> echo password_authentication > /etc/ssh/sshd_config</label>
                        <label><input type="radio" name="disable_cmd" value='sed -i "s/.*RSAAuthentication.*/RSAAuthentication no/g" /etc/ssh/sshd_config'> sed -i "s/.*RSAAuthentication.*/RSAAuthentication no/g" /etc/ssh/sshd_config</label>
                    </div>
                </div>
                <div id="implement-tab" class="sim6-tab-content">
                    <p>Select the command to make the configuration changes take effect.</p>
                    <div class="sim6-radio-options" id="implement-options">
                        <label><input type="radio" name="implement_cmd" value="systemctl restart sshd"> systemctl restart sshd</label>
                        <label><input type="radio" name="implement_cmd" value="systemctl disable sshd"> systemctl disable sshd</label>
                        <label><input type="radio" name="implement_cmd" value="systemctl daemon-reload sshd"> systemctl daemon-reload sshd</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(message, isCentered = false) {
            modalBody.textContent = message;
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { modal.style.display = "none"; }
        modal.querySelector('.modal-close-btn').onclick = closeModal;
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const sim6 = {
            state: 0, 
            dom: {
                terminalOutput: document.getElementById('terminal-output'),
                commandInput: document.getElementById('command-input'),
                serverModal: document.getElementById('sim6-server-modal'),
                serverIcon: document.getElementById('sim6-server-icon'),
                workstationIcon: document.getElementById('sim6-workstation-icon')
            },
            data: {
                info: `A senior administrator has tasked you with setting up remote access into Linux Server 1.\n\nINSTRUCTIONS\nUsing the workstation, create an SSH PKI and copy it to the remote machine. Type 'help' to view a list of available commands.\n\nIn Server 1, disable password login for all users and implement the configuration changes.`
            },
            setup: function() {
                this.state = 0;
                this.dom.terminalOutput.innerHTML = '';
                this.dom.commandInput.value = '';
                this.appendToTerminal("Begin by generating an SSH key on the workstation. Type 'help' for a list of commands.");
                this.attachEvents();
            },
            appendToTerminal: function(text) {
                this.dom.terminalOutput.innerHTML += text.replace(/\n/g, "<br>") + "<br>";
                this.dom.terminalOutput.scrollTop = this.dom.terminalOutput.scrollHeight;
            },
            handleCommand: function() {
                const cmd = this.dom.commandInput.value.trim();
                if (!cmd) return;

                this.appendToTerminal(`<span style="color: #88ff88;">comptia@localhost ~#</span> ${cmd}`);
                this.dom.commandInput.value = '';

                switch(cmd) {
                    case 'help':
                        this.appendToTerminal(`Available Commands:\nssh-keygen\nssh-copy-id admin@server1`);
                        break;
                    case 'ssh-keygen':
                        if (this.state === 0) {
                            this.appendToTerminal(`Generating public/private rsa key pair...\nYour identification has been saved in /home/comptia/.ssh/id_rsa.\nYour public key has been saved in /home/comptia/.ssh/id_rsa.pub.`);
                            this.state = 1;
                        } else {
                            this.appendToTerminal(`Key already exists. Overwrite (y/n)? n`);
                        }
                        break;
                    case 'ssh-copy-id admin@server1':
                        if (this.state === 1) {
                            this.appendToTerminal(`/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed...\nNumber of key(s) added: 1\n\nNow try logging into the machine, with: "ssh 'admin@server1'"`);
                            this.state = 2;
                        } else {
                            this.appendToTerminal(`ERROR: please generate an SSH key first using 'ssh-keygen'.`);
                        }
                        break;
                    default:
                        this.appendToTerminal(`-bash: ${cmd}: command not found`);
                }
            },
            attachEvents: function() {
                this.dom.commandInput.onkeydown = (e) => { if (e.key === 'Enter') this.handleCommand(); };
                
                this.dom.workstationIcon.onclick = () => {
                    showModal("Simulation has been reset.", true);
                    this.setup();
                };

                this.dom.serverIcon.onclick = () => {
                    if (this.state < 2) {
                        showModal("Task incomplete. You must successfully generate and copy the SSH key from the workstation to the server before proceeding with this step.");
                    } else {
                        this.dom.serverModal.style.display = 'flex';
                    }
                };
                this.dom.serverModal.querySelector('.sim6-close-button').onclick = () => { this.dom.serverModal.style.display = 'none'; };

                const tabs = this.dom.serverModal.querySelectorAll('.sim6-modal-tab-btn');
                const tabContents = this.dom.serverModal.querySelectorAll('.sim6-tab-content');
                tabs.forEach(tab => {
                    tab.onclick = () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        this.dom.serverModal.querySelector(`#${tab.dataset.tab}-tab`).classList.add('active');
                    };
                });

                this.dom.serverModal.querySelector('#disable-options').onchange = (e) => {
                    if (this.state === 2) {
                        if (e.target.value.includes("PasswordAuthentication no")) {
                            this.state = 3;
                            showModal("Correct! Password authentication disabled. Now apply the change.", true);
                            tabs.forEach(t => t.classList.remove('active'));
                            this.dom.serverModal.querySelector('[data-tab="implement"]').classList.add('active');
                            tabContents.forEach(c => c.classList.remove('active'));
                            this.dom.serverModal.querySelector('#implement-tab').classList.add('active');
                        } else {
                            showModal("Incorrect. This does not disable password login.", true);
                            e.target.checked = false;
                        }
                    }
                };
                this.dom.serverModal.querySelector('#implement-options').onchange = (e) => {
                    if (this.state === 3) {
                        if (e.target.value === "systemctl restart sshd") {
                            this.state = 4;
                            this.dom.serverModal.style.display = 'none';
                            showModal("Simulation Complete! You have successfully configured passwordless SSH access.", true);
                        } else {
                            showModal("Incorrect. Review the options and try again.", true);
                            e.target.checked = false;
                        }
                    } else {
                        showModal("First, disable password authentication in the previous tab.", true);
                        e.target.checked = false;
                    }
                };
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            sim6.setup();
            document.getElementById('infoBtn').onclick = () => {
                showModal(sim6.data.info);
            };
        });
    </script>
</body>
</html>