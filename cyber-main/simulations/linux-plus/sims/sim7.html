<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 7: LVM Recovery</title>
    <link rel="stylesheet" href="../../../assets/style.css">
    <style>
        .sim-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .info-btn { padding: 8px; background-color: var(--interactive-blue); border: none; border-radius: 5px; cursor: pointer; color: white; line-height: 0; }
        .info-btn:hover { background-color: var(--interactive-blue-hover); }
        .info-btn svg { width: 24px; height: 24px; fill: currentColor; }

        #sim-main-container {
            display: grid;
            grid-template-areas:
                "instructions instructions"
                "commands     terminal"
                "prompt       prompt";
            grid-template-columns: 300px 1fr;
            grid-gap: 1.5rem;
            background-color: var(--bg-dark-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .instructions-box { 
            grid-area: instructions; 
        }

        .instructions-box h4 { 
            margin-top: 0; 
        }

        .instructions-box .part-instructions { 
            display: none; 
        }

        .instructions-box .part-instructions.active { 
            display: block; 
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 1rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background-color: var(--bg-dark-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 1em;
            margin-right: 5px;
            border-radius: 4px;
        }

        .tab-btn.active {
            background-color: var(--interactive-blue);
            color: white;
            border-color: var(--interactive-blue);
        }

        .commands-list {
            grid-area: commands;
            background-color: var(--bg-dark-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            color: rgb(38, 131, 38);
            font-family: monospace;
        }

        .command-item {
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .command-item:hover {
            background-color: var(--bg-dark-secondary);
        }

        .command-item.selected {
            background-color: rgb(35, 85, 35);
            color: white;
        }

        .terminal-box {
            grid-area: terminal;
            background-color: #1e1e1e;
            color: #dcdcdc;
            font-family: 'Consolas', 'Monaco', monospace;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            white-space: pre;
            overflow-x: auto;
            min-height: 300px;
        }
        
        .prompt-box {
            grid-area: prompt;
            background-color: var(--bg-dark-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .prompt-box .prompt-label {
            font-family: monospace;
            font-weight: bold;
            white-space: nowrap;
        }

        .prompt-box select {
            width: 100%;
            background: var(--bg-dark);
            color: rgb(80, 79, 79);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
        }

    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
            <a href="../index.html" class="back-btn">Back to Linux+ Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <h3>Sim 7: LVM Recovery</h3>
        
        <div id="sim-main-container">
            <div class="instructions-box">
                <div class="tab-nav">
                    <button class="tab-btn active" data-part="part1">Part 1</button>
                    <button class="tab-btn" data-part="part2">Part 2</button>
                    <button class="tab-btn" data-part="part3">Part 3</button>
                </div>
                <h4>INSTRUCTIONS</h4>
                <div id="part1-instructions" class="part-instructions active">A junior system administrator removed an LVM volume by mistake. Review the output and select the appropriate command to begin the recovery process.</div>
                <div id="part2-instructions" class="part-instructions">Review the output and select the appropriate command to continue the recovery process.</div>
                <div id="part3-instructions" class="part-instructions">Review the output and select the appropriate command to complete the recovery process and access the underlying data.</div>
            </div>

            <div class="commands-list" id="commands-list">
                </div>

            <div class="terminal-box" id="terminal-output">
                Select a command from the left to see its output.
            </div>

            <div class="prompt-box">
                <span class="prompt-label">[root@comptiasim ~]#</span>
                <select id="answer-dropdown"></select>
            </div>
        </div>
        
        <div class="sim-controls">
             <div></div>
             <div>
                <button class="sim-check-btn" id="checkBtn">Check Answer</button>
                <button class="sim-reset-btn" id="resetBtn">Reset All</button>
             </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <pre id="modal-body-content" style="white-space: pre-wrap; font-family: sans-serif;"></pre>
            <button class="modal-close-btn">Close</button>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(message, isCentered = false) {
            modalBody.textContent = message;
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { modal.style.display = "none"; }
        modal.querySelector('.modal-close-btn').onclick = closeModal;
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const simLVM = {
            data: {
                info: `A junior system administrator removed an LVM volume by mistake.\n\nINSTRUCTIONS\nPart 1: Review the output and select the appropriate command to begin the recovery process.\nPart 2: Review the output and select the appropriate command to continue the recovery process.\nPart 3: Review the output and select the appropriate command to complete the recovery process and access the underlying data.\n\nIf at any time you would like to bring back the initial state of the simulation, please click the Reset All button.`,
                part1: {
                    commands: {
                        "df -h": `Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        1.9G     0  1.9G   0% /dev
tmpfs           1.9G     0  1.9G   0% /dev/shm
tmpfs           1.9G   17M  1.9G   1% /run
tmpfs           1.9G     0  1.9G   0% /sys/fs/cgroup
/dev/xvda1      8.0G  1.1G  7.0G  13% /
tmpfs           379M     0  379M   0% /run/user/1000`,
                        "ls -l /dev | grep -v tty": `total 0
crw-------. 1 root root      10, 235 Jul 15 14:13 autofs
drwxr-xr-x. 2 root root          100 Jul 15 14:30 block
crw-------. 1 root root      10, 234 Jul 15 14:13 btrfs-control
drwxr-xr-x. 2 root root         2340 Jul 15 14:13 char
crw-------. 1 root root       5,   1 Jul 15 14:13 console
lrwxrwxrwx. 1 root root           11 Jul 15 14:13 core -> /proc/kcore
drwxr-xr-x. 4 root root           80 Jul 15 14:13 cpu
crw-------. 1 root root      10,  60 Jul 15 14:13 char
crw-------. 1 root root      10,  61 Jul 15 14:13 char
drwxr-xr-x. 4 root root           80 Jul 15 14:13 disk
drwxr-xr-x. 2 root root           80 Jul 15 14:13 dri
crw-rw----. 1 root root      29,   0 Jul 15 14:13 fb0`,
                        "ls -l /etc/lvm/archive": `total 12
-rw-------. 1 root root 879 Jul 14 16:49 vg01_00000-450576720.vg
-rw-------. 1 root root 883 Jul 14 16:50 vg01_00001-810050352.vg
-rw-------. 1 root root 1293 Jul 14 16:54 vg01_00002-966141411.vg`,
                        "pvdisplay": `  --- Physical volume ---
  PV Name               /dev/xvdf
  VG Name               vg01
  PV Size               10.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              2559
  Free PE               2559
  Allocated PE          0
  PV UUID               1uyvyk-Ffd0-RrYf-cYba-15zC-EHRZ-1N3UHm`,
                        "pvs": `  PV         VG   Fmt  Attr PSize   PFree
  /dev/xvdf  vg01 lvm2 a--  <10.00g <10.00g`,
                        "vgcfgrestore --list vg01": `  File:              /etc/lvm/archive/vg01_00000-450576720.vg
  VG name:           vg01
  Description:       Created *before* executing 'vgcreate vg01 /dev/xvdf'
  Backup Time:       Wed Jul 14 16:49:41 2021

  File:              /etc/lvm/archive/vg01_00001-810050352.vg
  VG name:           vg01
  Description:       Created *before* executing 'lvcreate -L 9G -n lv01 vg01'
  Backup Time:       Wed Jul 14 16:50:39 2021`,
                        "vgdisplay": `  --- Volume group ---
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               <10.00 GiB
  PE Size               4.00 MiB
  Total PE              2559
  Alloc PE / Size       0 / 0
  Free  PE / Size       2559 / <10.00 GiB
  VG UUID               4M2Jtr-vOnc-kTu0-qwdr-E176-RYZb-FxKCH4`,
                        "vgs": `  VG   #PV #LV #SN Attr   VSize   VFree
  vg01   1   0   0 wz--n- <10.00g <10.00g`
                    },
                    dropdownOptions: ["vgcfgrestore vg01 -f /etc/lvm/archive/vg01_00002-966141411.vg", 
                    "vgcfgrestore vg01 -t -M /etc/lvm/archive/vg01_00001-810050352.vg",
                    "vgcfgrestore vg01 -f /etc/lvm/backup/vg01",
                    "lvchange -a y /dev/vg01/lv01",
                    "lvconvert --type mirror lv01",
                    "lvchange -a n /dev/vg01/lv01",
                    "pvscan"],
                    correctAnswer: "vgcfgrestore vg01 -f /etc/lvm/archive/vg01_00002-966141411.vg"
                },
                part2: {
                    commands: {
                        "blkid": `  /dev/xvda1: UUID="388a99ed-9486-4a46-ae86-06eaf6c47675" TYPE="xfs"
  /dev/xvdf: UUID="1uyvyk-Ffd0-RrYf-cYba-15zC-EHRZ-1N3UHm" TYPE="LVM2_member"`,
                        "dmesg | tail -20":`[    7.204777] [drm] vram aper at 0xf0000000
[    7.725937] [drm] size 33554432
[    7.730741] [drm] fb depth is 16
[    7.737013] [drm]    pitch is 2048
[    7.744500] fbcon: cirrusdrmfb (fb0) is primary device
[    7.757228] ppdev: user-space parallel port driver
[    7.764342] alg: No test for __gcm-aes-aesni (__driver-gcm-aes-aesni)
[    7.764368] alg: No test for __generic-gcm-aes-aesni (__driver-generic-gcm-aes-aesni)
[    7.803909] Console: switching to colour frame buffer device 128x48
[    7.828579] cirrus 0000:00:02.0: fb0: cirrusdrmfb frame buffer device
[    7.843400] [drm] Initialized cirrus 1.0.0 20110418 for 0000:00:02.0 on minor 0`,
                        "lsblk": `NAME      MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvda      202:0    0   8G  0 disk
└─xvda1   202:1    0   8G  0 part /
xvdf      202:80   0  10G  0 disk`,
                        "ls /": "bin   boot  dev  etc   home  important_data  lib   lib64  media  mnt  opt\nproc  root  run   sbin  srv   sys   tmp   usr   var",
                        "lvdisplay": `--- Logical volume ---
LV Path                /dev/vg01/lv01
LV Name                lv01
VG Name                vg01
LV UUID                xMqAgf-wMax-AvSm-JQGP-XzFA-gnRt-08xq7d
LW Write Access        read/write
LV Creation host, time comptiasim, 2021-07-14 16:50:39 +0000
LV Status              NOT available
LV Size                9.00 GiB
Current LE             230
Segments               1
Allocation             inherit
Read ahead sectors     auto`,
                        "lvs": `  LV   VG   Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv01 vg01 -wi------- 9.00g`,
                        "lvscan": `  inactive          '/dev/vg01/lv01' [9.00 GiB] inherit`,
                        "pvs": "  PV         VG   Fmt  Attr PSize   PFree\n  /dev/xvdf  vg01 lvm2 a--  <10.00g 1020.00m",
                        "vgs": "  VG   #PV #LV #SN Attr   VSize   VFree\n  vg01   1   1   0 wz--n- <10.00g 1020.00m"
                    },
                    dropdownOptions: [
                    "pvchange -x y /dev/xvdf", 
                    "lvextend -L +S4 vg01/lv01 /dev/xvdf", 
                    "lvchange -a y /dev/vg01/lv01", 
                    "lvchange -a n /dev/vg01/lv01", 
                    "mount /dev/vg01/lv01 /important_data"],
                    correctAnswer: "lvchange -a y /dev/vg01/lv01"
                },
                part3: {
                    commands: {
                        "blkid": `/dev/xvda1: UUID="388a99ed-9486-4a46-ae86-06eaf6c47675" TYPE="xfs"
/dev/mapper/vg01-lv01: UUID="c63883e9-ceca-45f4-9ad9-f8d9c1014c7e" TYPE="xfs"
/dev/xvdf: UUID="1uyvyk-Ffd0-RrYf-cYba-15zC-EHRZ-1N3UHm" TYPE="LVM2_member"`,
                        "cat /etc/fstab": `#
# /etc/fstab
# Created by anaconda on Sat Feb 29 12:05:47 2020
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8), and/or blkid(8) for more info
#
UUID=388a99ed-9486-4a46-ae86-06eaf6c47675 /       xfs   defaults   0 0
/dev/vg01/lv01 /important_data                    xfs   defaults   0 0`,
                        "ls -l /dev/mapper/": `total 0
crw-------. 1 root root 10, 236 Jul 15 14:13 control
lrwxrwxrwx. 1 root root       7 Jul 15 14:13 vg01-lv01 -> ../dm-0`,
                        "ls -l /": `total 16
lrwxrwxrwx.   1 root root    7 Feb 29  2020 bin -> usr/bin
drwxr-xr-x.   5 root root 4096 Jul 14 14:21 boot
drwxr-xr-x.  19 root root 2780 Jul 15 14:48 dev
drwxr-xr-x.  79 root root 8192 Jul 15 14:24 etc
drwxr-xr-x.   3 root root   20 Jul 14 14:20 home
drwxr-xr-x.   2 root root   28 Jul 14 16:53 important_data
lrwxrwxrwx.   1 root root    7 Feb 29  2020 lib -> usr/lib
lrwxrwxrwx.   1 root root    9 Feb 29  2020 lib64 -> usr/lib64
drwxr-xr-x.   2 root root    6 Apr 11  2018 media
drwxr-xr-x.   2 root root    6 Apr 11  2018 mnt
drwxr-xr-x.   2 root root    6 Apr 11  2018 opt
drwxr-xr-x. 145 root root    0 Jul 15 14:13 proc`,
                        "lsblk": `NAME        MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvda        202:0    0   8G  0 disk
└─xvda1     202:1    0   8G  0 part /
xvdf        202:80   0  10G  0 disk
└─vg01-lv01 253:0    0   9G  0 lvm`,
                        "lvdisplay": `--- Logical volume ---
LV Path                /dev/vg01/lv01
LV Name                lv01
VG Name                vg01
LV UUID                xMqAgf-wMax-AvSm-JQGP-XzFA-gnRt-08xq7d
LV Write Access        read/write
LV Creation host, time comptiasim, 2011-07-14 16:50:39 +0000
LV Status              available
# open                 0
Lv Size                9.00 GiB
Current LE             2304
Segments               1
Allocation             inherit`,
                        "lvscan": `  ACTIVE            '/dev/vg01/lv01' [9.00 GiB] inherit`,
                        "tail -f /var/log/messages": `Jul 15 14:13:31 comptiasim systemd: Created slice User Slice of centos
Jul 15 14:13:31 comptiasim systemd: Started Session 1 of user centos
Jul 15 14:13:31 comptiasim systemd-logind: New session 1 of user centos
Jul 15 14:13:36 comptiasim su: (to root) centos on pts/0                       
Jul 15 14:14:11 comptiasim kernel: XFS (dm-0): Mounting V5 Filesystem
Jul 15 14:14:11 comptiasim kernel: XFS (dm-0): Ending clean mount
Jul 15 14:16:20 comptiasim kernel: XFS (dm-0): Unmounting Filesystem
Jul 15 14:24:27 comptiasim yum[1558]: Installed: libreport-filesystem-2.1.11-53.e17.centos.x86_64
Jul 15 14:24:27 comptiasim systemd: Reloading.
Jul 15 14:24:27 comptiasim yum[1558]: Installed: mdadm-4.1-7.e17_9.x86_64`,
                        "xfs_repair -n /dev/vg01/lv01": `Phase 1 - find and verify superblock...
Phase 2 - using internal log
        - zero log...
        - scan filesystem freespace and inode maps...
        - found root inode chunk
Phase 3 - for each AG...
        - scan (but don't clear) agi unlinked lists...
        - process known inodes and perform inode discovery...
        - process newly discovered inodes...
Phase 4 - check for duplicate blocks...
        - setting up duplicate extent list...
        - check for inodes claiming duplicate blocks...
No modify flag set, skipping phase 5
Phase 6 - check inode connectivity...
        - traversing filesystem ...
        - moving disconnected inodes to lost+found ...
Phase 7 - verify link counts...
        - link counts ok.`
                    },
                    dropdownOptions: ["xfs_repair /dev/vg01/lv01", "mount /dev/xvdf /important_data", "mount /dev/vg01/lv01 /important_data", "cat /important_data/secret_file.txt"],
                    correctAnswer: "mount /dev/vg01/lv01 /important_data"
                }
            },
            state: {
                currentPart: "part1",
                selectedCommand: null,
                answers: { part1: "", part2: "", part3: "" }
            },
            setup: function() {
                this.state = { currentPart: "part1", selectedCommand: null, answers: { part1: "", part2: "", part3: "" }};
                this.switchPart('part1');
            },
            switchPart: function(partId) {
                this.state.currentPart = partId;
                this.state.selectedCommand = null;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.part === partId));
                document.querySelectorAll('.part-instructions').forEach(inst => inst.classList.toggle('active', inst.id.startsWith(partId)));
                const commands = this.data[partId].commands;
                const commandList = document.getElementById('commands-list');
                commandList.innerHTML = '';
                Object.keys(commands).forEach(cmd => {
                    const item = document.createElement('div');
                    item.className = 'command-item';
                    item.textContent = `# ${cmd}`;
                    item.dataset.command = cmd;
                    commandList.appendChild(item);
                });
                const dropdown = document.getElementById('answer-dropdown');
                const options = this.data[partId].dropdownOptions;
                dropdown.innerHTML = `<option value="" selected disabled>Select command</option>` + options.map(o => `<option value="${o}">${o}</option>`).join('');
                dropdown.value = this.state.answers[partId];
                document.getElementById('terminal-output').textContent = "Select a command from the left to see its output.";
            },
            selectCommand: function(command) {
                this.state.selectedCommand = command;
                document.querySelectorAll('.command-item').forEach(item => {
                    item.classList.toggle('selected', item.dataset.command === command);
                });
                const output = this.data[this.state.currentPart].commands[command];
                document.getElementById('terminal-output').textContent = `[root@comptiasim ~]# ${command}\n\n${output}`;
            },
            check: function() {
                this.state.answers[this.state.currentPart] = document.getElementById('answer-dropdown').value;
                const results = [];
                let allCorrect = true;
                for (let i = 1; i <= 3; i++) {
                    const partId = `part${i}`;
                    const userAnswer = this.state.answers[partId];
                    const correctAnswer = this.data[partId].correctAnswer;
                    if (userAnswer === correctAnswer) {
                        results.push(`Part ${i}: Correct`);
                    } else {
                        results.push(`Part ${i}: Incorrect`);
                        allCorrect = false;
                    }
                }
                let feedback = results.join('\n');
                if (allCorrect) {
                    feedback += "\n\nSuccess! The LVM volume has been recovered and mounted.";
                } else {
                    feedback += "\n\nReview the incorrect part(s).";
                }
                showModal(feedback, true);
            },
            init: function() {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.state.answers[this.state.currentPart] = document.getElementById('answer-dropdown').value;
                        this.switchPart(btn.dataset.part);
                    });
                });
                document.getElementById('commands-list').addEventListener('click', (e) => {
                    if (e.target && e.target.classList.contains('command-item')) {
                        this.selectCommand(e.target.dataset.command);
                    }
                });
                document.getElementById('checkBtn').addEventListener('click', () => this.check());
                document.getElementById('resetBtn').addEventListener('click', () => this.setup());
                document.getElementById('infoBtn').addEventListener('click', () => showModal(this.data.info));
                
                this.setup();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            simLVM.init();
        });
    </script>
<script src="/cyber-main/disable_dev_tools.js"></script>
</body>
</html>