<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 2: OAuth Workflow</title>
    <link rel="stylesheet" href="../../../assets/style.css">
    <style>
        .sim-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .info-btn {
            padding: 8px;
            background-color: var(--interactive-blue);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            line-height: 0;
        }

        .info-btn:hover {
            background-color: var(--interactive-blue-hover);
        }

        .info-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        #sim76-content {
            background-color: var(--bg-dark-secondary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            height: 550px;
            font-family: monospace;
        }

        #diagram-wrapper {
            margin: 0 auto;
            position: relative;
            width: 800px;
            height: 520px;
        }
        
        .oauth-component {
            position: absolute;
            width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .device-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 10px;
        }

        .device-icon .outline {
            stroke: #0f0;
            stroke-width: 1.5;
            fill: none;
        }

        .device-icon .detail {
            stroke: #0f0;
            stroke-width: 1;
        }

         .device-icon .lights {
            fill: #0f0;
        }

        .oauth-component .label {
            font-weight: bold;
            color: #0f0;
            background-color: #000000;
            border: 1px solid #0f0;
            padding: 5px;
            border-radius: 4px;
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
        }

        .oauth-component select {
            width: 100%;
            background: #000000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            border-radius: 4px;
        }
        
        #resource-owner { 
            top: 250px; left: 0px; 
        }

        #auth-server { 
            top: 230px; left: 260px; 
        }

        #resource-server { 
            top: 80px;  left: 580px; 
        }

        #b2b-client { 
            top: 380px; left: 580px; 
        }

        .arrow-path {
            fill: none;
            stroke: #0f0;
            stroke-width: 2;
            marker-end: url(#arrow-head);
        }
    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
            <a href="../index.html" class="back-btn">Back to SecurityX Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <h3>Sim 2: OAuth Workflow</h3>
        <p>Use the drop-down menus to select the action items for the appropriate server roles in the OAuth workflow.</p>
        
        <div id="sim76-content">
            <div id="diagram-wrapper">
                <svg width="100%" height="100%" style="position:absolute; top:0; left:0; z-index:0;">
                    <defs>
                        <marker id="arrow-head" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M 0 0 L 10 5 L 0 10 z" fill="#0f0"></path>
                        </marker>
                    </defs>
                    <path class="arrow-path" d="M 180 275 L 280 275"></path>
                    <path class="arrow-path" d="M 450 275 Q 520 275 540 170 L 560 170"></path>
                    <path class="arrow-path" d="M 450 275 Q 520 275 540 460 L 560 460"></path>
                </svg>

                <div id="resource-owner" class="oauth-component">
                    <svg class="device-icon" viewBox="0 0 24 24">
                        <path class="outline" d="M3 14V5a1 1 0 011-1h16a1 1 0 011 1v9H3z"/>
                        <path class="lights" d="M2 15h20a1 1 0 011 1v1a1 1 0 01-1 1H2a1 1 0 01-1-1v-1a1 1 0 011-1z"/>
                    </svg>
                    <span class="label">Resource owner</span>
                </div>
                <div id="auth-server" class="oauth-component">
                     <svg class="device-icon" viewBox="0 0 24 24">
                        <rect class="outline" x="3" y="4" width="18" height="16" rx="1"/>
                        <line class="detail" x1="7" y1="8" x2="17" y2="8"/>
                        <line class="detail" x1="7" y1="12" x2="17" y2="12"/>
                        <circle class="lights" cx="8" cy="16" r="1"/>
                    </svg>
                    <span class="label">Authorization server</span>
                    <select id="select-auth-server"></select>
                </div>
                <div id="resource-server" class="oauth-component">
                    <svg class="device-icon" viewBox="0 0 24 24">
                        <rect class="outline" x="3" y="4" width="18" height="16" rx="1"/>
                        <line class="detail" x1="7" y1="8" x2="17" y2="8"/>
                        <line class="detail" x1="7" y1="12" x2="17" y2="12"/>
                        <circle class="lights" cx="8" cy="16" r="1"/>
                    </svg>
                    <span class="label">Resource server</span>
                    <select id="select-resource-server"></select>
                </div>
                <div id="b2b-client" class="oauth-component">
                    <svg class="device-icon" viewBox="0 0 24 24">
                        <rect class="outline" x="3" y="4" width="18" height="16" rx="1"/>
                        <line class="detail" x1="7" y1="8" x2="17" y2="8"/>
                        <line class="detail" x1="7" y1="12" x2="17" y2="12"/>
                        <circle class="lights" cx="8" cy="16" r="1"/>
                    </svg>
                    <span class="label">B2B client application</span>
                    <select id="select-b2b-client"></select>
                </div>
            </div>
        </div>
        
        <div class="sim-controls">
             <div></div>
             <div>
                <button class="sim-check-btn" id="checkBtn">Check Answer</button>
                <button class="sim-reset-btn" id="resetBtn">Reset All</button>
             </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <pre id="modal-body-content" style="white-space: pre-wrap; font-family: sans-serif;"></pre>
            <button class="modal-close-btn">Close</button>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(message, isCentered = false) {
            modalBody.textContent = message;
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { modal.style.display = "none"; }
        modal.querySelector('.modal-close-btn').onclick = closeModal;
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const sim76 = {
            data: {
                info: `You are tasked with integrating a new B2B client application with an existing OAuth workflow that must meet the following requirements:\n\n• The application does not need to know the users’ credentials.\n• An approval interaction between the users and the HTTP service must be orchestrated.\n• The application must have limited access to users’ data.\n\nINSTRUCTIONS\nUse the drop-down menus to select the action items for the appropriate locations. All placeholders must be filled.`,
                options: ["Authorize access to other applications", "Access issued tokens", "Grant access"],
                correctAnswers: {
                    authServer: "Authorize access to other applications",
                    resourceServer: "Access issued tokens",
                    b2bClient: "Grant access"
                }
            },
            setup: function() {
                const selects = {
                    authServer: document.getElementById('select-auth-server'),
                    resourceServer: document.getElementById('select-resource-server'),
                    b2bClient: document.getElementById('select-b2b-client')
                };

                const placeholder = `<option value="" disabled selected>Select action item</option>`;
                const optionsHtml = placeholder + this.data.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');

                for (const key in selects) {
                    if (selects.hasOwnProperty(key)) {
                        selects[key].innerHTML = optionsHtml;
                    }
                }
            },
            check: function() {
                const userAnswers = {
                    authServer: document.getElementById('select-auth-server').value,
                    resourceServer: document.getElementById('select-resource-server').value,
                    b2bClient: document.getElementById('select-b2b-client').value
                };

                const correct = this.data.correctAnswers;
                const isCorrect = userAnswers.authServer === correct.authServer &&
                                  userAnswers.resourceServer === correct.resourceServer &&
                                  userAnswers.b2bClient === correct.b2bClient;

                if (isCorrect) {
                    showModal("Correct! You have correctly identified the roles in the OAuth workflow.", true);
                } else {
                    showModal("Incorrect. Please review the roles and actions in the OAuth 2.0 Authorization Code flow.", true);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            sim76.setup();
            document.getElementById('checkBtn').addEventListener('click', sim76.check.bind(sim76));
            document.getElementById('resetBtn').addEventListener('click', sim76.setup.bind(sim76));
            document.getElementById('infoBtn').onclick = () => {
                showModal(sim76.data.info);
            };
        });
    </script>
</body>
</html>