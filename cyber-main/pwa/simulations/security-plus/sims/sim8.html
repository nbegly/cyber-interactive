<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim 8: Vulnerability Assessment</title>
    <link rel="stylesheet" href="../../../../assets/style.css">
    <style>
        .sim-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .info-btn {
            padding: 8px;
            background-color: var(--interactive-blue);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            line-height: 0;
        }

        .info-btn:hover {
            background-color: var(--interactive-blue-hover);
        }

        .info-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .vuln-container { 
            background-color: var(--bg-dark-secondary); 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px;
        }

        .vuln-controls-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
        }

        .vuln-network-btn { 
            background-color: var(--bg-dark-tertiary); 
            color: white; 
            padding: 15px; 
            border-radius: 5px; 
            border: none; 
            font-size: 1.1em; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }

        .vuln-network-btn:hover { 
            background-color: var(--interactive-blue-hover); 
        }

        .sim8-modal-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
        }

        .sim8-device-card { 
            background-color: var(--bg-dark-secondary); 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
        }

        .sim8-device-card h4 { 
            margin-top: 0; 
            color: var(--accent-green); 
            border-bottom: 1px solid var(--accent-green); 
            padding-bottom: 5px; 
        }

        .sim8-vuln-info { 
            font-size: 0.9em; 
            margin-bottom: 15px; 
            line-height: 1.5; 
        }

        .sim8-remediation-group select { 
            width: 100%; 
            padding: 8px; 
            background-color: var(--bg-dark-main); 
            color: var(--text-light); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            margin-top: 5px;
        }
        
    </style>
</head>
<body>

    <div class="sim-container">
        <div class="sim-top-bar">
        <a href="../index.html" class="back-btn">Back to Menu</a>
            <button id="infoBtn" class="info-btn" title="Show Instructions">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>

        <h3>Sim 8: Vulnerability Assessment</h3>
        <div class="vuln-container">
            <h4>Solutions/Controls:</h4>
            <div class="vuln-controls-container">
                <button class="vuln-network-btn" data-network="CORPORATE NETWORK">CORPORATE NETWORK +</button>
                <button class="vuln-network-btn" data-network="PERIMETER NETWORK">PERIMETER NETWORK +</button>
                <button class="vuln-network-btn" data-network="SERVER NETWORK">SERVER NETWORK +</button>
            </div>
        </div>
        <div class="sim-controls">
            <div></div>
            <div>
                <button class="sim-check-btn" id="checkBtn">Check Answer</button>
                <button class="sim-reset-btn" id="resetBtn">Reset Sim</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div id="modal-body-content"></div>
        </div>
    </div>

    <script>
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body-content");
        function showModal(content, isCentered = true, options = {}) {
            modalBody.innerHTML = '';
            if (options.isWide) modal.classList.add('modal-wide');
            if (typeof content === 'string') {
                const p = document.createElement('p');
                p.style.whiteSpace = 'pre-wrap';
                p.textContent = content;
                modalBody.appendChild(p);
            } else {
                modalBody.appendChild(content);
            }
            if (!options.noCloseButton) {
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Close';
                closeButton.className = 'modal-close-btn';
                closeButton.onclick = closeModal;
                modalBody.appendChild(closeButton);
            }
            modal.querySelector('.modal-content').classList.toggle('centered-text', isCentered);
            modal.style.display = "flex";
        }
        function closeModal() { 
            modal.style.display = "none"; 
            modal.classList.remove('modal-wide');
        }
        modal.onclick = e => { if (e.target.id === 'modal') closeModal(); };

        const sim8 = {
            state: {},
            data: {
                info: `SIMULATION\nYou received the output of a recent vulnerability assessment.\n\nINSTRUCTIONS\nReview the assessment and scan output and determine the appropriate remediation(s) for each device.\n\nRemediation options may be selected multiple times, and some devices may require more than one remediation.\n\nIf at any time you would like to bring back the initial state of the simulation, please click the Reset Sim button.`,
                remediationOptions: ["", "Update antivirus signatures", "Update cipher suite", "Generate new CSR", "Install OS security update", "Change default password", "Patch application", "Uninstall unneeded application"],
                networks: {
                    "CORPORATE NETWORK": {
                        devices: [
                            { id: "client10", name: "Client 10", ip: "192.168.1.10", vuln: "<strong>Vulnerability:</strong> High (CVSS: 10.0)<br><strong>NVT:</strong> MS15-034 HTTP.sys remote Code Execution Vulnerability (remote check)<br><strong>Summary:</strong> This host is missing an important security update according to Microsoft Bulletin MS15-034", remediations: [{ id: "r1", correct: "Install OS security update" }] },
                            { id: "client11", name: "Client 11", ip: "192.168.1.11", vuln: "<strong>Vulnerability:</strong> Low (CVSS: 2.6)<br><strong>NVT:</strong> TCP Timestamps (OID 1.3.6.1.4.1.2523.1.0.80091)<br><strong>Summary:</strong> The remote host implement TCP timestamps and therefore allows to compute the uptime.", remediations: [{ id: "r1", correct: "Install OS security update" }] },
                        ]
                    },
                    "PERIMETER NETWORK": {
                        devices: [
                            { id: "webserver", name: "Web Server", ip: "10.25.20.20", vuln: "<strong>Vulnerability:</strong> Medium (CVSS: 4.3)<br><strong>NVT:</strong> SSL/TLS: Deprecated SSLv2 and SSLv3 Protocol Detection<br><strong>Summary:</strong> It was possible to detect the usage of the deprecated SSLv2 and/or SSLv3 protocol on this system.", remediations: [{ id: "r1", correct: "Update cipher suite" }, { id: "r2", correct: "Generate new CSR" }] }
                        ]
                    },
                    "SERVER NETWORK": {
                        devices: [
                            { id: "dc", name: "Domain Controller", ip: "172.27.0.25", vuln: "<strong>Vulnerability:</strong> High (CVSS: 4.0)<br><strong>NVT:</strong> SSL/TLS: Certificate Signed Using A Weak Signature Algorithm<br><strong>Summary:</strong> The remote service is using a SSL/TLS certificate in the certificate chain that has been signed using a cryptographically weak hashing algorithm.", remediations: [{ id: "r1", correct: "Update cipher suite" }] },
                            { id: "db", name: "Database Server", ip: "172.27.0.30", vuln: "<strong>Vulnerability:</strong> High (CVSS: 9.0)<br><strong>NVT:</strong> MySQL / MariaDB Weak Password<br><strong>Summary:</strong> It was possible to login into the remote MySQL as root using weak credentials.<hr><strong>Vulnerability:</strong> Medium (CVSS: 6.8)<br><strong>NVT:</strong> MySQL Multiple Vulnerabilities<br><strong>Summary:</strong> MySQL is prone to security bypass vulnerability and to a local privilege escalation vulnerability.", remediations: [{ id: "r1", correct: "Change default password" }, { id: "r2", correct: "Patch application" }] }
                        ]
                    }
                }
            },
            setup: function() {
                this.state = {};
                document.querySelectorAll('.vuln-network-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.showNetworkModal(e.target.dataset.network);
                    });
                });
            },
            showNetworkModal: function(networkName) {
                const networkData = this.data.networks[networkName];
                if (!networkData) return;

                const modalContent = document.createElement('div');
                modalContent.className = 'sim8-modal-grid';
                modalContent.innerHTML = networkData.devices.map(device => {
                    const remediationHTML = device.remediations.map(rem => `
                        <div class="sim8-remediation-group">
                            <label for="${device.id}-${rem.id}">Select Remediation</label>
                            <select id="${device.id}-${rem.id}" data-device-id="${device.id}" data-rem-id="${rem.id}">
                                ${this.data.remediationOptions.map(opt => `<option value="${opt}" ${this.state[`${device.id}-${rem.id}`] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `).join('');

                    return `
                        <div class="sim8-device-card">
                            <h4>${device.name} <small>(${device.ip})</small></h4>
                            <div class="sim8-vuln-info">${device.vuln}</div>
                            ${remediationHTML}
                        </div>`;
                }).join('');

                modalContent.querySelectorAll('select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        this.state[e.target.id] = e.target.value;
                    });
                });

                showModal(modalContent, false, { isWide: true, noCloseButton: false });
            },
            check: function() {
                let correctDevicesCount = 0;
                let totalDevices = 0;
                let allRemediationsAttempted = true;

                for (const networkName in this.data.networks) {
                    const network = this.data.networks[networkName];
                    totalDevices += network.devices.length;

                    for (const device of network.devices) {
                        const correctAnswersForDevice = device.remediations.map(r => r.correct).sort();
                        const userAnswersForDevice = [];
                        
                        for (const rem of device.remediations) {
                            const selectId = `${device.id}-${rem.id}`;
                            const userAnswer = this.state[selectId];
                            
                            if (!userAnswer || userAnswer === "") {
                                allRemediationsAttempted = false;
                            }
                            userAnswersForDevice.push(userAnswer);
                        }
                        
                        if (JSON.stringify(correctAnswersForDevice) === JSON.stringify(userAnswersForDevice.sort())) {
                            correctDevicesCount++;
                        }
                    }
                }

                if (!allRemediationsAttempted) {
                    showModal("Please provide a remediation for all listed vulnerabilities before checking the answer.", true);
                    return;
                }

                const isCorrect = correctDevicesCount === totalDevices;
                showModal(isCorrect ? "Correct! All vulnerabilities have been properly remediated." : `Incorrect. You have correctly configured ${correctDevicesCount} out of ${totalDevices} devices. Please review your selections.`, true);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            sim8.setup();
            document.getElementById('checkBtn').addEventListener('click', () => sim8.check());
            document.getElementById('resetBtn').addEventListener('click', () => sim8.setup());
            document.getElementById('infoBtn').onclick = () => {
                showModal(sim8.data.info, false);
            };
        });
    </script>
<script src="../../../../disable_dev_tools.js"></script>
</body>
</html>
